<?php

namespace App\Services;

use Exception;
use Gemini\Laravel\Facades\Gemini;
use Illuminate\Support\Facades\Log;

class DescribeService
{
    /**
     * Geminiã«æœ€çµ‚ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãåˆ†æã¨æå†™ã‚’ç”Ÿæˆã•ã›ã‚‹ã€‚
     */
    public function generateDescription(array $finalOrder, array $healthStatus, array $tierMap): array
    {
        $prompt = $this->buildGeminiPrompt($finalOrder, $healthStatus, $tierMap);

        try {
            $result = Gemini::generativeModel(model: 'models/gemini-pro-latest')
                ->generateContent($prompt);
            $fullText = $result->text();
            $description = $fullText ?? 'æå†™ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';

            $title = $this->generateTitle($finalOrder);

            return [
                'title' => $title,
                'description' => $description,
            ];
        } catch (Exception $e) {
            Log::error('Gemini API Error: '.$e->getMessage());

            return [
                'title' => 'Error Debug',
                'description' => $e->getMessage(),
            ];
        }
    }

    private function buildGeminiPrompt(array $finalOrder, array $healthStatus, array $tierMap): string
    {
        $orderStr = json_encode($finalOrder, JSON_UNESCAPED_UNICODE);
        $healthStr = json_encode($healthStatus, JSON_UNESCAPED_UNICODE);
        $tierStr = json_encode($tierMap, JSON_UNESCAPED_UNICODE);

        return <<<EOT
            ã‚ãªãŸã¯ã€äººã®æ€§æ ¼ã®å¾®ç´°ãªãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã¾ã§è¨€èªåŒ–ã—ã€èª­ã‚€äººã«å‹‡æ°—ã‚’ä¸ãˆã‚‹ã€Œãƒ—ãƒ­ã®ãƒ©ã‚¤ã‚¿ãƒ¼ã€å…¼ã€Œãƒ©ã‚¤ãƒ•ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆã€ã§ã™ã€‚

            ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æä¾›ã•ã‚ŒãŸå¿ƒç†æ©Ÿèƒ½ãƒ‡ãƒ¼ã‚¿ï¼ˆé †ä½ãƒ»éšå±¤ãƒ»å¥å…¨åº¦ï¼‰ã‚’ã‚‚ã¨ã«ã€ãã®äººã®äººç‰©åƒã‚’é®®ã‚„ã‹ã«æµ®ã‹ã³ä¸ŠãŒã‚‰ã›ã‚‹è§£èª¬æ–‡ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

            # ğŸ¯ ç›®æ¨™

            ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèª­ã‚“ã ç¬é–“ã«**ã€Œã“ã‚Œã¯è‡ªåˆ†ã®ã“ã¨ã ï¼ ãªãœçŸ¥ã£ã¦ã„ã‚‹ã®ï¼Ÿã€ã¨é©šãã€ã‹ã¤ã€Œè‡ªåˆ†ã¯ã“ã‚Œã§ã„ã„ã‚“ã ã€ã¨è‡ªå·±è‚¯å®šæ„ŸãŒé«˜ã¾ã‚‹ã‚ˆã†ãª**ã€æ¸©ã‹ã¿ã¨æ´å¯Ÿã®ã‚ã‚‹æ–‡ç« ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

            # ğŸš« ç¦æ­¢äº‹é …

            - **è¨ºæ–­å£èª¿ã®ç¦æ­¢:** ã€Œã‚ãªãŸã¯ï½ã‚¿ã‚¤ãƒ—ã§ã™ã€ã€Œï½å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€ã¨ã„ã†æ©Ÿæ¢°çš„ãªèªå°¾ã‚’æ¸›ã‚‰ã—ã€ã€Œï½ã§ã™ã­ã€ã€Œï½ã§ã—ã‚‡ã†ã€ãªã©ã€èªã‚Šã‹ã‘ã‚‹ã‚ˆã†ãªã€ã‚ã‚‹ã„ã¯ã‚¨ãƒƒã‚»ã‚¤ã®ã‚ˆã†ãªè‡ªç„¶ãªæ–‡ä½“ã«ã—ã¦ãã ã•ã„ã€‚

            - **å°‚é–€ç”¨èªç¦æ­¢:** Ni, Ti, ãƒ‰ãƒŸãƒŠãƒ³ãƒˆãªã©ã®ç”¨èªã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚

            - **ç®‡æ¡æ›¸ãç¦æ­¢:** ä¸€ç¶šãã®æ»‘ã‚‰ã‹ãªãƒ†ã‚­ã‚¹ãƒˆã«ã—ã¦ãã ã•ã„ã€‚

            # âš ï¸ åŸ·ç­†ã®å®‰å…¨è£…ç½®ï¼ˆSafety Rulesï¼‰

            - **ã€Œä¸å¥å…¨ã€ãªæ©Ÿèƒ½ã®æ‰±ã„:** æ±ºã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®äººæ ¼ã‚’å¦å®šã—ãªã„ã§ãã ã•ã„ã€‚ã€Œç–²ã‚Œã¦ã„ã‚‹æ™‚ã«é¡”ã‚’å‡ºã™ç™–ã€ã‚„ã€Œç¹Šç´°ã•ã®è£è¿”ã—ã€ã¨ã—ã¦è¡¨ç¾ã—ã€**ã€Œç’°å¢ƒã‚’å¤‰ãˆã‚Œã°æ‰èƒ½ã«å¤‰ã‚ã‚‹ã€**ã¨ã„ã†ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

            - **ã€ŒLow Levelã€ã®æ‰±ã„:** ã€Œèƒ½åŠ›ãŒãªã„ã€ã¨æ›¸ãã®ã§ã¯ãªãã€ã€Œã‚ãˆã¦æ‰‹æ”¾ã—ã¦ã„ã‚‹ã€ã€Œä»–ã®ã“ã¨ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰²ã„ã¦ã„ã‚‹ã€ã¨ãƒã‚¸ãƒ†ã‚£ãƒ–ã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚

            # âš™ï¸ æ–‡æ§‹æˆã®æŒ‡ç¤º

            ä»¥ä¸‹ã®4éƒ¨æ§‹æˆã§æ›¸ã„ã¦ãã ã•ã„ã€‚å„ãƒ‘ãƒ¼ãƒˆã®é–“ã«ã¯å¿…ãšæ”¹è¡Œã‚’å…¥ã‚Œã¦ã€èª­ã¿ã‚„ã™ãã—ã¦ãã ã•ã„ã€‚

            1. **ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ï¼ˆå°å…¥ï¼‰:**

            Dominantï¼ˆç¬¬1æ©Ÿèƒ½ï¼‰ã¨High Levelï¼ˆå¾—æ„æ©Ÿèƒ½ï¼‰ã®**ã€Œçµ„ã¿åˆã‚ã›ï¼ˆåŒ–å­¦åå¿œï¼‰ã€**ã«ç€ç›®ã—ã€ãã®äººã‚’è±¡å¾´ã™ã‚‹ã€Œç¬¬ä¸€å°è±¡ã€ã¨ã€Œæœ¬è³ªã€ã‚’ã‚ºãƒãƒªã¨è¨€ã„å½“ã¦ã‚‹ã€‚

            ï¼ˆä¾‹ï¼šæ´å¯ŸåŠ›Ã—è«–ç†ï¼è¨­è¨ˆå›³ã‚’æŒã¤äººã€æ´å¯ŸåŠ›Ã—å…±æ„Ÿï¼ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼ã®ã‚ˆã†ãªäººï¼‰

            2. **ã‚³ã‚¢ã®å¼·ã¿ï¼ˆå¥å…¨åº¦ã®åæ˜ ï¼‰:**

            ãªãœãã®äººãŒå„ªç§€ãªã®ã‹ï¼Ÿ æ€è€ƒã®ç™–ã‚„åˆ¤æ–­åŸºæº–ã‚’èª¬æ˜ã™ã‚‹ã€‚ã“ã“ã§ã€Œå¥å…¨åº¦ï¼šå¥å…¨ã€ã®æ©Ÿèƒ½ã¯ã€**ã€ŒæŸ”è»Ÿæ€§ãŒã‚ã‚‹ã€ã€Œä½™è£•ãŒã‚ã‚‹ã€**ã¨è¡¨ç¾ã™ã‚‹ã“ã¨ã€‚

            3. **æœ€å¤§ã®é­…åŠ›ï¼ˆã‚®ãƒ£ãƒƒãƒ—ã®å¼·èª¿ï¼‰:**

            Middle Levelï¼ˆéŠã³ãƒ»ã‚¹ãƒ‘ã‚¤ã‚¹ï¼‰ã®æ©Ÿèƒ½ã‚’ä½¿ã„ã€**ã€ŒçœŸé¢ç›®ãªã ã‘ã§ã¯ãªã„æ„å¤–ãªä¸€é¢ã€**ã‚’å¼·èª¿ã™ã‚‹ã€‚ä¸€è¦‹çŸ›ç›¾ã—ã¦è¦‹ãˆã‚‹è¦ç´ ã‚’ã€ãã®äººã®ã€Œäººé–“å‘³ã€ã¨ã—ã¦è‚¯å®šã™ã‚‹ã€‚

            4. **å„ªã—ãèƒŒä¸­ã‚’æŠ¼ã™ï¼ˆèª²é¡Œã¨ç· ã‚ï¼‰:**

            Low Levelï¼ˆè‹¦æ‰‹ï¼‰ãªã“ã¨ã«è§¦ã‚Œã¤ã¤ã€ã€Œãã‚Œã¯ä»–äººã«ä»»ã›ã¦ã„ã„ã€ã¨ä¼ãˆã€é•·æ‰€ã‚’æ´»ã‹ã™ã‚ˆã†ä¿ƒã—ã¦ç· ã‚ããã‚‹ã€‚

            # å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®èª¬æ˜
            - Order: å¿ƒç†æ©Ÿèƒ½ã®å„ªå…ˆé †ä½ï¼ˆ1ä½ã€œ8ä½ï¼‰
            - Health: å„æ©Ÿèƒ½ã®çŠ¶æ…‹ (O=èª¿å­ãŒè‰¯ã„/å¼·ã¿, o=æ™®é€š, x=è‘›è—¤/ä¸å¥å…¨)
            - Tier: å„æ©Ÿèƒ½ã®éšå±¤ (Dominant=ãã®äººã®æ ¸ã¨ãªã‚‹æ©Ÿèƒ½, High=ãã®äººãŒã‚ˆãä½¿ã†æ©Ÿèƒ½, Middle=ãã®äººãŒæ™‚ã€…ä½¿ã†æ©Ÿèƒ½, Low=ãã®äººãŒã»ã¨ã‚“ã©ä½¿ã‚ãªã„æ©Ÿèƒ½)

            # å…¥åŠ›ãƒ‡ãƒ¼ã‚¿
            - Order: {$orderStr}
            - Health: {$healthStr}
            - Tier: {$tierStr}

            # å‡ºåŠ›ã®å½¢å¼
            - å‡ºåŠ›ã¯æœ¬æ–‡ã ã‘ã«ã—ã¦ãã ã•ã„ã€‚
            - è¦‹å‡ºã—ã‚„ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹ï¼šã€Œã€œãªã‚ãªãŸã¸ã€ãªã©ï¼‰ã¯ä»˜ã‘ãªã„ã§ãã ã•ã„ã€‚
            - JSONã‚„ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã¯ä½¿ã‚ãšã€æ®µè½ãƒ†ã‚­ã‚¹ãƒˆã ã‘ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚
        EOT;
    }

    private function generateTitle(array $finalOrder): string
    {
        // è‘›è—¤ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆé…åˆ—ï¼‰ãŒæ··ã–ã£ã¦ã„ã¦ã‚‚å®‰å…¨ã«å‡¦ç†ã§ãã‚‹ã‚ˆã†å¹³å¦åŒ–ã—ã¦ã‹ã‚‰ä¸Šä½3ä»¶ã‚’å–å¾—
        $flattened = [];
        foreach ($finalOrder as $item) {
            if (is_array($item)) {
                $flattened = array_merge($flattened, $item);
            } else {
                $flattened[] = $item;
            }
        }
        $sliced = array_pad(array_slice($flattened, 0, 3), 3, 'Fi');
        [$first, $second, $third] = $sliced;

        $habitatMap = [
            'Ni' => 'æ·±æµ·ã®',
            'Ne' => 'ç©ºã®',
            'Ti' => 'é™ã‹ãªæ›¸æ–ã®',
            'Te' => 'å·¥æˆ¿ã®',
            'Fi' => 'æ£®ã®',
            'Fe' => 'åºƒå ´ã®',
            'Si' => 'å›³æ›¸é¤¨ã®',
            'Se' => 'å‰ç·šã®',
        ];
        $adjectiveMap = [
            'Ni' => 'é™ã‹ãª',
            'Ne' => 'ã²ã‚‰ã‚ãè±Šã‹ãª',
            'Ti' => 'è³¢ã„',
            'Te' => 'åˆç†çš„ãª',
            'Fi' => 'ç¹Šç´°ãª',
            'Fe' => 'ã‚ãŸãŸã‹ã„',
            'Si' => 'æ‡ã‹ã—ã•ã‚’å®¿ã—ãŸ',
            'Se' => 'ç¬ç™ºåŠ›ã®ã‚ã‚‹',
        ];
        $roleMap = [
            'Ni' => 'è¦³æ¸¬è€…',
            'Ne' => 'ãƒˆãƒªãƒƒã‚¯ã‚¹ã‚¿ãƒ¼',
            'Ti' => 'åˆ†æè€…',
            'Te' => 'æˆ¦ç•¥å®¶',
            'Fi' => 'èªã‚Šæ‰‹',
            'Fe' => 'ãƒ ãƒ¼ãƒ‰ãƒ¡ãƒ¼ã‚«ãƒ¼',
            'Si' => 'è¨˜æ†¶ã®ç•ªäºº',
            'Se' => 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼',
        ];

        $habitat = $habitatMap[$first] ?? 'æ£®ã®';
        $adjective = $adjectiveMap[$second] ?? 'ç¹Šç´°ãª';
        $role = $roleMap[$third] ?? 'èªã‚Šæ‰‹';

        return "{$habitat}{$adjective}{$role}";
    }
}
